@model IEnumerable<MediX.Models.MedicalCenterViewModel>

@{
    ViewBag.Title = "Map";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<link href='https://api.mapbox.com/mapbox-gl-js/v2.14.1/mapbox-gl.css' rel='stylesheet' />
<style>
    #map-container {
        height: 80vh;
        width: 100%;
    }

    #map {
        height: 100%;
        width: 100%;
    }
</style>

<h2>Map</h2>

<div id='map-container'>
    <div id='map'></div>
</div>

<div>
    @Html.ActionLink("Back to List", "Index", null, new { @class = "btn btn-primary" })
</div>

@section Scripts {
    @Scripts.Render("~/bundles/jqueryval")
    <script src='https://api.mapbox.com/mapbox-gl-js/v2.14.1/mapbox-gl.js'></script>
    <script>
        mapboxgl.accessToken = 'pk.eyJ1IjoidmluY2Vud2kiLCJhIjoiY2xubzU1aXZpMDF2aTJtcHNnajl1eGVyOSJ9.mTMkon0gJmWLwC9MWm3OiQ';

        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(function (position) {
                console.log(position)
                var map = new mapboxgl.Map({
                    container: 'map',
                    style: 'mapbox://styles/vincenwi/clno8ayrn00td01pvei9dd3d3',
                    center: [position.coords.longitude, position.coords.latitude],
                    zoom: 12
                });

                map.on('click', (event) => {
                    const features = map.queryRenderedFeatures(event.point, {
                        layers: ['medical-centers']
                    });
                    if (!features.length) {
                        return;
                    }
                    const feature = features[0];

                    const popup = new mapboxgl.Popup({ offset: [0, 15] })
                        .setLngLat(feature.geometry.coordinates)
                        .setHTML(
                            `<h3>${feature.properties['Name']}</h3>
                            <p>${feature.properties['Address']}</p>
                            <p>${feature.properties['Open Time']} - ${feature.properties['Close Time']}
                            <p><a href="/MedicalCenters/Details/${feature.properties['Id']}" target="_blank">Details</a></p>`
                        )
                        .addTo(map);
                })
            });
        } else {
            console.log("Geolocation is not supported by this browser.");
        }
    </script>
}
